{% extends "base-header.html" %}
{% load static %}
{% load bilan_filters %}
{% block title %} Bilan {% endblock %}

{% block styles %} 
<link href="{% static 'style-bilan.css'%}" rel="stylesheet"/>
<script src="{% static 'sort.js' %}"></script>
<script src="{% static 'color.js' %}"></script>
<script src="{% static 'send.js' %}"></script>
{% endblock %}

{% block content %}

<div style="display: flex; align-items: center;">
    <button class="white-button" onclick="location.href = '/'"><span style="margin-right: 10px;" class="material-symbols-rounded ">arrow_back</span> Retour</button>
    <form action="/export_bilans/{{date}}">
        <button class="white-button" ><span style="margin-right: 10px;" class="material-symbols-rounded ">download</span>Télécharger</button>
    </form>
    <button class="white-button" onclick="sendToConso()"><span style="margin-right: 10px;" class="material-symbols-rounded ">send</span>Envoyer</button>
</div>

<div>
    <table data-date="{{date}}" class="sortable">
        <thead>
            <th class="no-sort">Numéro étudiant <span aria-hidden="true"></span></th>
            <th><button>Nom <span aria-hidden="true"></span></button></th>
            <th><button>Prénom <span aria-hidden="true"></span></button></th>
            <th><button>Groupe <span aria-hidden="true"></span></button></th>
            {% for matiere, note in bilans.0.notes.items %}
                <th><button>QCM {{ matiere }} (/20) <span aria-hidden="true"></span></button></th>
            {% endfor %}
            <th class="no-sort">
                <button>
                  Demande conso. 
                  <span class="material-symbols-rounded" style="margin-right: 10px; font-size: 1.4em;">filter_alt</span>
                </button>
              </th>
            <th class="no-sort desc">Commentaires</th>
            {% for matiere, note in bilans.0.notes.items %}
                <th>Conso. {{ matiere }}</th>
            {% endfor %}
        </thead>

        <tbody>
            {% for bilan in bilans %}
                <tr>
                    <td>{{ bilan.numE }}</td>
                    <td>{{ bilan.nom }}</td>
                    <td>{{ bilan.prenom }}</td>
                    <td>{{ bilan.groupe }}</td>
                    {% for matiere, note in bilan.notes.items %}
                        <td class="student-info">{{ note }}
                            <table class="info-table">
                                <thead>
                                    <th>Historique QCM {{ matiere }}</th>
                                </thead>
                                <tbody class="matiere-info">
                                    {% for note_mat in bilan.notes_by_mat|get:matiere %}
                                        <tr class="skibidi">
                                            <td data-note="{{ note }}">{{ note_mat }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </td>
                    {% endfor %}
                    <td class="student-info filtre" data-matiere_demande="{{bilan.demande_en}}">
                        {% if bilan.demande == 'True' %} ✅ {% else %} ❌ {% endif %} {{ bilan.demande_en }}
                        
                        <table class="info-table">
                            <thead>
                                <tr>
                                    <th colspan=500>Historique des conso.</th>
                                </tr>
                            </thead>
                            
                            <tbody>
                                {% for matiere, consos in bilan.historique.items %}
                                    <tr>
                                        <td>{{matiere}}</td>

                                        {% for conso in consos %}
                                            <td>{{conso|safe}}</td>
                                        {% endfor %}
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                    </td>
                    <td>{{ bilan.desc }}</td>
                    {% for matiere, note in bilan.notes.items %}
                        <td data-nume="{{bilan.numE}}" data-matiere="{{ matiere }}" class="checkbox-column"><input type="checkbox"></td>
                    {% endfor %}
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
